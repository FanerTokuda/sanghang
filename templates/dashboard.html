<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Sang H√†ng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; padding: 10px; font-size: 14px; background-color: #f9f9f9; }
        .header { margin-bottom: 20px; }
        .back-link { text-decoration: none; color: #555; font-size: 14px; display: inline-block; margin-bottom: 10px;}
        h1 { margin: 5px 0 5px 0; font-size: 20px; color: #333; }
        .sub-info { font-size: 13px; color: #666; margin-bottom: 15px; }
        .export-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; border: none; cursor: pointer; color: white;}
        .btn-excel { background-color: #217346; }
        .btn-zip { background-color: #ffc107; color: #333; }
        .btn-add { background-color: #007bff; width: 100%; justify-content: center; padding: 12px; font-size: 15px;}
        .input-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-row input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .data-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        th { background: #f1f1f1; padding: 10px; text-align: left; color: #555; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #ddd;}
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; }
        .cont-label { font-size: 11px; color: #888; text-transform: uppercase; display: block;}
        .cont-val { font-weight: 500; color: #000; display: block; margin-bottom: 8px; font-size: 15px;}
        .pair-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .action-group { display: flex; gap: 8px; }
        .btn-icon { text-decoration: none; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-delete-pair { color: #dc3545; }
        .btn-edit-pair { color: #ffc107; }
        .photo-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .photo-wrapper { position: relative; width: 70px; height: 70px; }
        .photo-thumb { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
        .img-action-btn { position: absolute; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 12px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.3); cursor: pointer; }
        .btn-del { top: -8px; right: -8px; background: #ff4d4d; color: white; z-index: 10;}
        .btn-down { bottom: -8px; right: -8px; background: #fff; color: #333; border: 1px solid #ccc; z-index: 10;}
        .camera-btn { display: inline-flex; align-items: center; justify-content: center; width: 70px; height: 70px; border: 2px dashed #007bff; border-radius: 6px; background: #f0f7ff; color: #007bff; cursor: pointer; font-size: 28px; }
        input[type="file"] { display: none; }
        .btn-download-set { display: block; width: 100%; margin-top: 10px; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; text-align: center; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #dc3545; }
        .modal-title-edit { color: #007bff; }
        .modal-desc { font-size: 14px; color: #333; margin-bottom: 20px; line-height: 1.5; }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; }
        .btn-choice { padding: 12px; border: none; border-radius: 5px; font-size: 15px; font-weight: bold; cursor: pointer; color: white; width: 100%; }
        .btn-1n { background: #007bff; }
        .btn-11 { background: #6c757d; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="back-link">&larr; Quay l·∫°i danh s√°ch</a>
        <h1>Ng√†y: {{ session.work_date.strftime('%d-%m-%Y') }}</h1>
        <div class="sub-info">
            Ca: <b>{{ session.shift }}</b> | 
            Ph·ª• tr√°ch: <b>{{ session.worker_name }}</b> ({{ session.worker_count }} ng∆∞·ªùi)
        </div>
    </div>

    <div class="export-bar">
        <a href="/export_excel/{{ session._id }}" class="btn btn-excel">üì• Xu·∫•t Excel</a>
        <a href="/download_images/{{ session._id }}" class="btn btn-zip">üì¶ T·∫£i ZIP (T·∫•t c·∫£)</a>
    </div>

    <div class="input-card">
        <form method="POST" id="addPairForm">
            <div class="input-row">
                <input type="text" id="sourceCont" name="source_cont" placeholder="CONT R√öT" required autocomplete="off">
                <input type="text" name="target_cont" placeholder="CONT ƒê√ìNG" required autocomplete="off">
            </div>
            <button type="button" onclick="checkDuplicateAndSubmit()" class="btn btn-add">+ Th√™m C·∫∑p Cont M·ªõi</button>
        </form>
    </div>

    <div class="modal-overlay" id="duplicateModal">
        <div class="modal-box">
            <div class="modal-title">‚ö†Ô∏è Ph√°t hi·ªán tr√πng Cont R√∫t!</div>
            <div class="modal-desc">Cont <b id="duplicateContName"></b> ƒë√£ ƒë∆∞·ª£c nh·∫≠p.<br>B·∫°n ch·ªçn ki·ªÉu n√†o?</div>
            <div class="modal-actions">
                <button class="btn-choice btn-1n" onclick="confirm1n()">Sang 1-n (Ti·∫øp t·ª•c)</button>
                <button class="btn-choice btn-11" onclick="confirm11()">Sang 1-1 (H·ªßy)</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-box">
            <div class="modal-title modal-title-edit">‚úèÔ∏è C·∫≠p nh·∫≠t th√¥ng tin</div>
            <form id="editForm" method="POST" action="">
                <div class="input-row">
                    <input type="text" id="editSource" name="edit_source_cont" placeholder="CONT R√öT" required>
                </div>
                <div class="input-row">
                    <input type="text" id="editTarget" name="edit_target_cont" placeholder="CONT ƒê√ìNG" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn-choice btn-1n">üíæ L∆∞u Thay ƒê·ªïi</button>
                    <button type="button" class="btn-choice btn-11" onclick="closeEditModal()">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <div class="data-card">
        <table>
            <thead>
                <tr>
                    <th style="width: 35%">Th√¥ng tin Cont</th>
                    <th style="width: 65%">H√¨nh ·∫£nh</th>
                </tr>
            </thead>
            <tbody>
                {% for pair in session.pairs %}
                <tr>
                    <td>
                        <div class="pair-header">
                            <div>
                                <span class="cont-label">R√∫t (Ngu·ªìn):</span>
                                <span class="cont-val" id="src-{{ pair['_id'] }}">{{ pair['source_cont'] }}</span>
                            </div>
                            <div class="action-group">
                                {% if current_user.role == 'admin' %}
                                <span class="btn-icon btn-edit-pair" onclick="openEditModal('{{ pair['_id'] }}')" title="S·ª≠a">‚úé</span>
                                <a href="/delete_pair/{{ pair['_id'] }}" class="btn-icon btn-delete-pair" title="X√≥a c·∫∑p" onclick="return confirm('X√≥a c·∫∑p n√†y?')">&times;</a>
                                {% endif %}
                            </div>
                        </div>
                        <hr style="border: 0; border-top: 1px solid #eee; margin: 5px 0;">
                        <span class="cont-label">ƒê√≥ng (ƒê√≠ch):</span>
                        <span class="cont-val" id="tgt-{{ pair['_id'] }}">{{ pair['target_cont'] }}</span>
                    </td>
                    <td>
                        <div class="photo-list" id="gallery-{{ pair['_id'] }}">
                            {% if 'photos' in pair %}
                                {% for photo in pair['photos'] %}
                                <div class="photo-wrapper">
                                    <a href="/image/{{ photo }}" target="_blank">
                                        <img src="/image/{{ photo }}" class="photo-thumb">
                                    </a>
                                    {% if current_user.role == 'admin' %}
                                    <a href="/delete_image/{{ pair['_id'] }}/{{ photo }}" class="img-action-btn btn-del" onclick="return confirm('X√≥a ·∫£nh n√†y?')">&times;</a>
                                    {% endif %}
                                    <a href="/image/{{ photo }}" download class="img-action-btn btn-down">‚¨á</a>
                                </div>
                                {% endfor %}
                            {% endif %}

                            <div class="upload-container" style="position: relative;">
                                <div id="loading-{{ pair['_id'] }}" style="display:none; position:absolute; top:0; left:0; width:70px; height:70px; background:rgba(255,255,255,0.85); border-radius:6px; align-items:center; justify-content:center; z-index:20;">
                                    <div style="border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;"></div>
                                </div>
                                <form>
                                    <label for="file-{{ pair['_id'] }}" class="camera-btn">üì∑</label>
                                    <input id="file-{{ pair['_id'] }}" type="file" accept="image/*" onchange="handleUpload(this, '{{ pair['_id'] }}')">
                                </form>
                            </div>
                        </div>
                        {% if 'photos' in pair and pair['photos']|length > 0 %}
                        <button type="button" class="btn-download-set" onclick='downloadAll("{{ pair['_id'] }}")'>
                            ‚¨á L∆∞u {{ pair['photos']|length }} ·∫£nh v·ªÅ m√°y
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        function downloadAll(pairId) {
            var container = document.getElementById('gallery-' + pairId);
            var buttons = container.querySelectorAll('.btn-down');
            if (buttons.length === 0) { alert('Kh√¥ng c√≥ ·∫£nh!'); return; }
            buttons.forEach(function(btn, index) { setTimeout(function() { btn.click(); }, index * 800); });
        }

        const modal = document.getElementById('duplicateModal');
        const form = document.getElementById('addPairForm');
        const contInput = document.getElementById('sourceCont');
        const duplicateNameDisplay = document.getElementById('duplicateContName');

        function checkDuplicateAndSubmit() {
            const sourceVal = contInput.value.trim();
            const targetVal = document.querySelector('input[name="target_cont"]').value.trim();
            if (!sourceVal || !targetVal) { alert("Nh·∫≠p ƒë·ªß th√¥ng tin!"); return; }

            fetch('/check_duplicate/{{ session._id }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source_cont: sourceVal })
            })
            .then(response => response.json())
            .then(data => {
                if (data.exists) { duplicateNameDisplay.innerText = sourceVal; modal.style.display = 'flex'; }
                else { form.submit(); }
            })
            .catch(error => { form.submit(); });
        }

        function confirm1n() { modal.style.display = 'none'; form.submit(); }
        function confirm11() { modal.style.display = 'none'; form.reset(); }

        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editSource = document.getElementById('editSource');
        const editTarget = document.getElementById('editTarget');

        function openEditModal(pairId) {
            const currentSrc = document.getElementById('src-' + pairId).innerText;
            const currentTgt = document.getElementById('tgt-' + pairId).innerText;
            editSource.value = currentSrc;
            editTarget.value = currentTgt;
            editForm.action = '/update_pair/' + pairId;
            editModal.style.display = 'flex';
        }

        function closeEditModal() { editModal.style.display = 'none'; }

        async function handleUpload(input, pairId) {
            if (input.files.length === 0) return;
            const file = input.files[0];
            const loadingDiv = document.getElementById('loading-' + pairId);
            if(loadingDiv) loadingDiv.style.display = 'flex';
            try {
                const compressedFile = await compressImage(file, 1024, 0.7);
                const formData = new FormData();
                formData.append('photo', compressedFile, file.name);
                const response = await fetch('/upload_image/' + pairId, { method: 'POST', body: formData });
                if (response.ok) {
                    const htmlText = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');
                    const newGalleryContent = doc.getElementById('gallery-' + pairId).innerHTML;
                    document.getElementById('gallery-' + pairId).innerHTML = newGalleryContent;
                } else {
                    alert('L·ªói upload t·ª´ server!');
                    if(loadingDiv) loadingDiv.style.display = 'none';
                }
            } catch (error) {
                console.error(error);
                alert('L·ªói: ' + error.message);
                if(loadingDiv) loadingDiv.style.display = 'none';
            }
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            if (!blob) { reject(new Error('Canvas empty')); return; }
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }
    </script>
</body>
</html>
